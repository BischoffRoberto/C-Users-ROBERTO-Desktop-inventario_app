<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ARCHIVO VENCIMIENTO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h1 class="text-center mb-4 text-primary text-uppercase fw-bold">ARCHIVO VENCIMIENTO</h1>

    <!-- Formulario -->
    <div class="card p-4 mb-4 shadow-lg border-0">
        <h4 class="mb-3 text-success">âž• Agregar producto</h4>
        <div class="row g-3">
            <div class="col-12 col-md-4">
                <label class="form-label">CÃ³digo</label>
                <input type="text" id="codigo" inputmode="numeric" pattern="[0-9]*"
                       class="form-control form-control-sm" placeholder="CÃ³digo del producto">
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Nombre del artÃ­culo</label>
                <input type="text" id="nombre" list="articulos" class="form-control form-control-sm" placeholder="Seleccione o escribe para filtrar">
                <datalist id="articulos"></datalist>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Fecha de vencimiento</label>
                <input type="date" id="fecha" class="form-control form-control-sm">
            </div>
        </div>
        <button class="btn btn-success btn-sm mt-3 w-100" onclick="agregarProducto()">Agregar producto</button>
    </div>

    <!-- BotÃ³n fijo de guardar Excel -->
    <div class="mb-4">
        <button class="btn btn-warning btn-sm w-100" onclick="guardarLista()">Guardar y descargar Excel</button>
    </div>

    <!-- Lista de productos con toggle -->
    <div class="card p-4 shadow-lg border-0">
        <h4 class="mb-3 text-warning d-flex justify-content-between align-items-center">
            ðŸ“‹ Lista de productos
            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleLista()">Mostrar/Ocultar</button>
        </h4>
        <ul id="lista" class="list-group"></ul>
    </div>

    <div id="mensaje" class="alert d-none mt-3"></div>
</div>

<!-- LibrerÃ­a para Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
function mostrarMensaje(texto, tipo="info") {
    const msg = document.getElementById("mensaje");
    msg.className = `alert alert-${tipo}`;
    msg.textContent = texto;
    msg.classList.remove("d-none");
}

// Toggle lista
function toggleLista() {
    const lista = document.getElementById("lista");
    lista.classList.toggle("d-none");
}

// Flujo con Enter
document.getElementById("codigo").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("fecha").focus();
    }
});
document.getElementById("fecha").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        agregarProducto();
    }
});

// Agregar producto
function agregarProducto() {
    const cod = document.getElementById("codigo").value.trim();
    const nom = document.getElementById("nombre").value.trim();
    const fecha = document.getElementById("fecha").value.trim();

    if (!cod && !nom) {
        mostrarMensaje("Ingresa cÃ³digo o nombre", "warning");
        return;
    }
    if (cod && nom) {
        mostrarMensaje("Ingresa SOLO cÃ³digo O nombre, no ambos", "warning");
        return;
    }
    if (!fecha) {
        mostrarMensaje("Ingresa fecha de vencimiento", "warning");
        return;
    }

    const lista = document.getElementById("lista");
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.textContent = `${cod || nom} - vence: ${fecha}`;
    const btn = document.createElement("button");
    btn.className = "btn btn-sm btn-danger";
    btn.textContent = "Borrar";
    btn.onclick = () => { lista.removeChild(li); };
    li.appendChild(btn);
    lista.appendChild(li);

    mostrarMensaje("Producto agregado correctamente", "success");

    // Reset y volver a cÃ³digo
    document.getElementById("codigo").value = "";
    document.getElementById("nombre").value = "";
    document.getElementById("fecha").value = "";
    document.getElementById("codigo").focus();
}

// Guardar Excel
function guardarLista() {
    const lista = document.getElementById("lista");
    const items = lista.querySelectorAll("li");
    if (items.length === 0) {
        mostrarMensaje("No hay productos para guardar", "warning");
        return;
    }

    // Crear datos para Excel
    const data = [["CÃ³digo/Nombre", "Fecha de vencimiento"]];
    items.forEach(li => {
        const texto = li.firstChild.textContent;
        const partes = texto.split(" - vence: ");
        data.push([partes[0], partes[1]]);
    });

    // Crear hoja y libro
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Productos");

    // Descargar archivo
    XLSX.writeFile(wb, "productos.xlsx");
    mostrarMensaje("Excel generado y descargado", "success");
}
</script>

<!-- Input alternativo -->
<div class="container mt-2">
    <div class="mb-3">
        <input type="text" id="articulo" list="articulos" class="form-control form-control-sm">
    </div>
</div>

<!-- Tabla dinÃ¡mica -->
<div class="container mt-3">
    <table id="tablaProductos" class="table table-sm"></table>
</div>

</body>
</html>
